name: Publish to NuGet

on:
  release:
    types: [ published ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Package version (leave empty to use project version)'
        required: false
        type: string

jobs:
  publish:
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: |
          6.0.x
          7.0.x
          8.0.x
          9.0.x
          10.0.x

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --configuration Release --no-restore

    - name: Test
      run: dotnet test --configuration Release --no-build --verbosity normal

    - name: Extract version from tag
      id: get_version
      shell: pwsh
      run: |
        $version = "${{ github.event.inputs.version }}"
        if ([string]::IsNullOrEmpty($version)) {
          if ("${{ github.event_name }}" -eq "release") {
            $version = "${{ github.event.release.tag_name }}"
            # Remove 'v' prefix if present
            $version = $version -replace '^v', ''
          }
        }
        if ([string]::IsNullOrEmpty($version)) {
          $version = "1.0.0"
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Package version: $version"

    - name: Pack NuGet
      run: dotnet pack src/GtaImg/GtaImg.csproj --configuration Release --no-build -p:PackageVersion=${{ steps.get_version.outputs.VERSION }} --output ./nupkg

    - name: Publish GtaImgTool
      run: dotnet publish src/GtaImgTool/GtaImgTool.csproj --configuration Release --output ./publish/GtaImgTool

    - name: Create ZIP archive
      shell: pwsh
      run: |
        $version = "${{ steps.get_version.outputs.VERSION }}"
        Compress-Archive -Path ./publish/GtaImgTool/* -DestinationPath "./GtaImgTool-v$version-win-x64.zip"

    - name: Upload NuGet package artifact
      uses: actions/upload-artifact@v4
      with:
        name: nuget-package
        path: ./nupkg/*.nupkg

    - name: Upload Tool artifact
      uses: actions/upload-artifact@v4
      with:
        name: tool-package
        path: ./GtaImgTool-*.zip

    - name: Publish to NuGet
      shell: pwsh
      run: |
        $packages = Get-ChildItem -Path ./nupkg -Filter *.nupkg
        foreach ($package in $packages) {
          Write-Host "Pushing $($package.FullName)"
          dotnet nuget push $package.FullName --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
        }

    - name: Upload to GitHub Release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: ./GtaImgTool-*.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
