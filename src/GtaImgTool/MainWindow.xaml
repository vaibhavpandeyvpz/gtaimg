<Window x:Class="GtaImgTool.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:GtaImgTool.ViewModels"
        xmlns:fa="http://schemas.fontawesome.io/icons/"
        Title="{Binding WindowTitle}"
        Icon="pack://application:,,,/icon.ico"
        Height="480" Width="720"
        MinHeight="480" MinWidth="720"
        WindowStyle="None"
        AllowsTransparency="True"
        Background="Transparent"
        FontFamily="{StaticResource NotoSans}"
        WindowStartupLocation="CenterScreen"
        AllowDrop="True"
        Drop="Window_Drop"
        DragOver="Window_DragOver">
    
    <Window.DataContext>
        <vm:MainViewModel />
    </Window.DataContext>

    <Window.InputBindings>
        <KeyBinding Key="N" Modifiers="Ctrl" Command="{Binding NewArchiveCommand}" />
        <KeyBinding Key="O" Modifiers="Ctrl" Command="{Binding OpenArchiveCommand}" />
        <KeyBinding Key="S" Modifiers="Ctrl" Command="{Binding SaveArchiveCommand}" />
        <KeyBinding Key="W" Modifiers="Ctrl" Command="{Binding CloseArchiveCommand}" />
        <KeyBinding Key="A" Modifiers="Ctrl" Command="{Binding SelectAllCommand}" />
        <KeyBinding Key="Delete" Command="{Binding DeleteSelectedCommand}" />
        <KeyBinding Key="F5" Command="{Binding RefreshCommand}" />
    </Window.InputBindings>

    <Border Background="{StaticResource PrimaryBrush}" BorderBrush="{StaticResource BorderBrush}" BorderThickness="1">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!-- Custom Title Bar -->
            <Grid Grid.Row="0" Background="{StaticResource SecondaryBrush}" Height="32"
                  MouseLeftButtonDown="TitleBar_MouseLeftButtonDown">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!-- App Icon and Title -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center" Margin="8,0,0,0">
                    <Image Source="pack://application:,,,/icon.ico" Width="16" Height="16" Margin="0,0,8,0" />
                    <TextBlock Text="{Binding WindowTitle}" Foreground="{StaticResource TextPrimaryBrush}" 
                               FontSize="12" VerticalAlignment="Center" />
                </StackPanel>

                <!-- Window Controls -->
                <StackPanel Grid.Column="2" Orientation="Horizontal">
                    <!-- Minimize -->
                    <Button x:Name="MinimizeButton" Width="46" Height="32" Click="MinimizeButton_Click"
                            Background="Transparent" BorderThickness="0" Cursor="Hand">
                        <Button.Template>
                            <ControlTemplate TargetType="Button">
                                <Border x:Name="border" Background="{TemplateBinding Background}">
                                    <fa:ImageAwesome x:Name="icon" Icon="WindowMinimize" Width="10" Height="10" 
                                                     Foreground="{StaticResource TextSecondaryBrush}" VerticalAlignment="Center" />
                                </Border>
                                <ControlTemplate.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter TargetName="border" Property="Background" Value="#333333" />
                                        <Setter TargetName="icon" Property="Foreground" Value="{StaticResource TextPrimaryBrush}" />
                                    </Trigger>
                                </ControlTemplate.Triggers>
                            </ControlTemplate>
                        </Button.Template>
                    </Button>
                    <!-- Maximize/Restore -->
                    <Button x:Name="MaximizeButton" Width="46" Height="32" Click="MaximizeButton_Click"
                            Background="Transparent" BorderThickness="0" Cursor="Hand">
                        <Button.Template>
                            <ControlTemplate TargetType="Button">
                                <Border x:Name="border" Background="{TemplateBinding Background}">
                                    <fa:ImageAwesome x:Name="icon" Icon="WindowMaximize" Width="10" Height="10" 
                                                     Foreground="{StaticResource TextSecondaryBrush}" VerticalAlignment="Center" />
                                </Border>
                                <ControlTemplate.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter TargetName="border" Property="Background" Value="#333333" />
                                        <Setter TargetName="icon" Property="Foreground" Value="{StaticResource TextPrimaryBrush}" />
                                    </Trigger>
                                </ControlTemplate.Triggers>
                            </ControlTemplate>
                        </Button.Template>
                    </Button>
                    <!-- Close -->
                    <Button x:Name="CloseButton" Width="46" Height="32" Click="CloseButton_Click"
                            Background="Transparent" BorderThickness="0" Cursor="Hand">
                        <Button.Template>
                            <ControlTemplate TargetType="Button">
                                <Border x:Name="border" Background="{TemplateBinding Background}">
                                    <fa:ImageAwesome x:Name="icon" Icon="Times" Width="10" Height="10" 
                                                     Foreground="{StaticResource TextSecondaryBrush}" VerticalAlignment="Center" />
                                </Border>
                                <ControlTemplate.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter TargetName="border" Property="Background" Value="#ed1b2e" />
                                        <Setter TargetName="icon" Property="Foreground" Value="White" />
                                    </Trigger>
                                </ControlTemplate.Triggers>
                            </ControlTemplate>
                        </Button.Template>
                    </Button>
                </StackPanel>
            </Grid>

            <!-- Menu Bar -->
            <Menu Grid.Row="1">
            <MenuItem Header="_File">
                <MenuItem Header="_New Archive..." Command="{Binding NewArchiveCommand}" InputGestureText="Ctrl+N">
                    <MenuItem.Icon>
                        <fa:ImageAwesome Icon="File" Width="14" Height="14" Foreground="{StaticResource TextPrimaryBrush}" />
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="_Open Archive..." Command="{Binding OpenArchiveCommand}" InputGestureText="Ctrl+O">
                    <MenuItem.Icon>
                        <fa:ImageAwesome Icon="FolderOpen" Width="14" Height="14" Foreground="{StaticResource TextPrimaryBrush}" />
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="_Save" Command="{Binding SaveArchiveCommand}" InputGestureText="Ctrl+S">
                    <MenuItem.Icon>
                        <fa:ImageAwesome Icon="Save" Width="14" Height="14" Foreground="{StaticResource TextPrimaryBrush}" />
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="_Close" Command="{Binding CloseArchiveCommand}" InputGestureText="Ctrl+W">
                    <MenuItem.Icon>
                        <fa:ImageAwesome Icon="Times" Width="14" Height="14" Foreground="{StaticResource TextPrimaryBrush}" />
                    </MenuItem.Icon>
                </MenuItem>
                <Separator />
                <MenuItem Header="E_xit" Command="{Binding ExitCommand}" InputGestureText="Alt+F4">
                    <MenuItem.Icon>
                        <fa:ImageAwesome Icon="SignOut" Width="14" Height="14" Foreground="{StaticResource TextPrimaryBrush}" />
                    </MenuItem.Icon>
                </MenuItem>
            </MenuItem>
            <MenuItem Header="_Edit">
                <MenuItem Header="Select _All" Command="{Binding SelectAllCommand}" InputGestureText="Ctrl+A" 
                          Click="SelectAll_Click">
                    <MenuItem.Icon>
                        <fa:ImageAwesome Icon="CheckSquare" Width="14" Height="14" Foreground="{StaticResource TextPrimaryBrush}" />
                    </MenuItem.Icon>
                </MenuItem>
                <Separator />
                <MenuItem Header="_Delete Selected" Command="{Binding DeleteSelectedCommand}" InputGestureText="Del">
                    <MenuItem.Icon>
                        <fa:ImageAwesome Icon="Trash" Width="14" Height="14" Foreground="{StaticResource TextPrimaryBrush}" />
                    </MenuItem.Icon>
                </MenuItem>
            </MenuItem>
            <MenuItem Header="_Import">
                <MenuItem Header="Import _Files..." Command="{Binding ImportFilesCommand}">
                    <MenuItem.Icon>
                        <fa:ImageAwesome Icon="Download" Width="14" Height="14" Foreground="{StaticResource TextPrimaryBrush}" />
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="Import _Folder..." Command="{Binding ImportFolderCommand}">
                    <MenuItem.Icon>
                        <fa:ImageAwesome Icon="Folder" Width="14" Height="14" Foreground="{StaticResource TextPrimaryBrush}" />
                    </MenuItem.Icon>
                </MenuItem>
            </MenuItem>
            <MenuItem Header="_Export">
                <MenuItem Header="Export _Selected..." Command="{Binding ExportSelectedCommand}">
                    <MenuItem.Icon>
                        <fa:ImageAwesome Icon="Upload" Width="14" Height="14" Foreground="{StaticResource TextPrimaryBrush}" />
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="Export _All..." Command="{Binding ExportAllCommand}">
                    <MenuItem.Icon>
                        <fa:ImageAwesome Icon="Archive" Width="14" Height="14" Foreground="{StaticResource TextPrimaryBrush}" />
                    </MenuItem.Icon>
                </MenuItem>
            </MenuItem>
            <MenuItem Header="_Tools">
                <MenuItem Header="_Pack Archive" Command="{Binding PackArchiveCommand}">
                    <MenuItem.Icon>
                        <fa:ImageAwesome Icon="Compress" Width="14" Height="14" Foreground="{StaticResource TextPrimaryBrush}" />
                    </MenuItem.Icon>
                </MenuItem>
                <Separator />
                <MenuItem Header="_Refresh" Command="{Binding RefreshCommand}" InputGestureText="F5">
                    <MenuItem.Icon>
                        <fa:ImageAwesome Icon="Refresh" Width="14" Height="14" Foreground="{StaticResource TextPrimaryBrush}" />
                    </MenuItem.Icon>
                </MenuItem>
            </MenuItem>
            <MenuItem Header="_Help">
                <MenuItem Header="_About" Click="About_Click">
                    <MenuItem.Icon>
                        <fa:ImageAwesome Icon="InfoCircle" Width="14" Height="14" Foreground="{StaticResource TextPrimaryBrush}" />
                    </MenuItem.Icon>
                </MenuItem>
            </MenuItem>
        </Menu>

        <!-- Toolbar -->
            <Border Grid.Row="2" Background="{StaticResource SecondaryBrush}" Padding="8,4">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <!-- File Operations -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <Button Style="{StaticResource ToolbarButton}" Command="{Binding NewArchiveCommand}" 
                            ToolTip="New Archive (Ctrl+N)">
                        <StackPanel Orientation="Horizontal">
                            <fa:ImageAwesome Icon="File" Width="14" Height="14" Foreground="{StaticResource TextPrimaryBrush}" Margin="0,0,6,0" />
                            <TextBlock Text="New" VerticalAlignment="Center" />
                        </StackPanel>
                    </Button>
                    <Button Style="{StaticResource ToolbarButton}" Command="{Binding OpenArchiveCommand}"
                            ToolTip="Open Archive (Ctrl+O)">
                        <StackPanel Orientation="Horizontal">
                            <fa:ImageAwesome Icon="FolderOpen" Width="14" Height="14" Foreground="{StaticResource TextPrimaryBrush}" Margin="0,0,6,0" />
                            <TextBlock Text="Open" VerticalAlignment="Center" />
                        </StackPanel>
                    </Button>
                    <Button Style="{StaticResource ToolbarButton}" Command="{Binding SaveArchiveCommand}"
                            ToolTip="Save Archive (Ctrl+S)">
                        <StackPanel Orientation="Horizontal">
                            <fa:ImageAwesome Icon="Save" Width="14" Height="14" Foreground="{StaticResource TextPrimaryBrush}" Margin="0,0,6,0" />
                            <TextBlock Text="Save" VerticalAlignment="Center" />
                        </StackPanel>
                    </Button>
                </StackPanel>

                <Rectangle Grid.Column="1" Width="1" Fill="{StaticResource BorderBrush}" Margin="8,4" />

                <!-- Entry Operations -->
                <StackPanel Grid.Column="2" Orientation="Horizontal">
                    <Button Style="{StaticResource ToolbarButton}" Command="{Binding ImportFilesCommand}"
                            ToolTip="Import Files">
                        <StackPanel Orientation="Horizontal">
                            <fa:ImageAwesome Icon="Download" Width="14" Height="14" Foreground="{StaticResource TextPrimaryBrush}" Margin="0,0,6,0" />
                            <TextBlock Text="Import" VerticalAlignment="Center" />
                        </StackPanel>
                    </Button>
                    <Button Style="{StaticResource ToolbarButton}" Command="{Binding ExportSelectedCommand}"
                            ToolTip="Export Selected Files">
                        <StackPanel Orientation="Horizontal">
                            <fa:ImageAwesome Icon="Upload" Width="14" Height="14" Foreground="{StaticResource TextPrimaryBrush}" Margin="0,0,6,0" />
                            <TextBlock Text="Export" VerticalAlignment="Center" />
                        </StackPanel>
                    </Button>
                    <Button Style="{StaticResource ToolbarButton}" Command="{Binding DeleteSelectedCommand}"
                            ToolTip="Delete Selected (Del)">
                        <StackPanel Orientation="Horizontal">
                            <fa:ImageAwesome Icon="Trash" Width="14" Height="14" Foreground="{StaticResource TextPrimaryBrush}" Margin="0,0,6,0" />
                            <TextBlock Text="Delete" VerticalAlignment="Center" />
                        </StackPanel>
                    </Button>
                </StackPanel>

                <!-- Search Box -->
                <Border x:Name="SearchBorder" Grid.Column="3" Background="{StaticResource SurfaceBrush}" CornerRadius="0" 
                        BorderBrush="#333333" BorderThickness="1" Padding="8,4" 
                        MinWidth="150" MaxWidth="250" HorizontalAlignment="Right" Margin="8,0,0,0">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        <fa:ImageAwesome Grid.Column="0" Icon="Search" Width="12" Height="12" 
                                         Foreground="{StaticResource TextSecondaryBrush}" Margin="0,0,8,0" VerticalAlignment="Center" />
                        <TextBox x:Name="SearchTextBox" Grid.Column="1" Text="{Binding SearchFilter, UpdateSourceTrigger=PropertyChanged}"
                                 Background="Transparent" BorderThickness="0" VerticalAlignment="Center"
                                 Foreground="{StaticResource TextPrimaryBrush}" MinWidth="100"
                                 CaretBrush="{StaticResource AccentBrush}"
                                 SelectionBrush="{StaticResource AccentBrush}"
                                 SelectionTextBrush="White"
                                 GotFocus="SearchTextBox_GotFocus"
                                 LostFocus="SearchTextBox_LostFocus" />
                    </Grid>
                </Border>
            </Grid>
        </Border>

        <!-- Main Content -->
            <Grid Grid.Row="3">
            <!-- Empty State -->
            <Border Visibility="{Binding IsArchiveOpen, Converter={StaticResource InverseBoolToVisibilityConverter}}"
                    Background="{StaticResource SurfaceBrush}">
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                    <TextBlock Text="GTA IMG Tool" FontSize="28" FontWeight="Bold" 
                               Foreground="{StaticResource TextPrimaryBrush}" HorizontalAlignment="Center" />
                    <TextBlock Text="Open or create an IMG archive to get started" FontSize="14"
                               Foreground="{StaticResource TextSecondaryBrush}" HorizontalAlignment="Center" 
                               Margin="0,8,0,24" />
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                        <Button Style="{StaticResource PrimaryButton}" Command="{Binding OpenArchiveCommand}"
                                Margin="0,0,12,0">
                            <StackPanel Orientation="Horizontal">
                                <fa:ImageAwesome Icon="FolderOpen" Width="14" Height="14" Foreground="White" Margin="0,0,8,0" VerticalAlignment="Center" />
                                <TextBlock Text="Open Archive" VerticalAlignment="Center" />
                            </StackPanel>
                        </Button>
                        <Button Style="{StaticResource SecondaryButton}" Command="{Binding NewArchiveCommand}">
                            <StackPanel Orientation="Horizontal">
                                <fa:ImageAwesome Icon="File" Width="14" Height="14" Foreground="{StaticResource TextPrimaryBrush}" Margin="0,0,8,0" VerticalAlignment="Center" />
                                <TextBlock Text="New Archive" VerticalAlignment="Center" />
                            </StackPanel>
                        </Button>
                    </StackPanel>
                    <TextBlock Text="or drag and drop an IMG file here" FontSize="12"
                               Foreground="{StaticResource TextSecondaryBrush}" HorizontalAlignment="Center" 
                               Margin="0,16,0,0" />
                </StackPanel>
            </Border>

            <!-- File List -->
            <DataGrid x:Name="FileGrid"
                      Visibility="{Binding IsArchiveOpen, Converter={StaticResource BoolToVisibilityConverter}}"
                      ItemsSource="{Binding FilteredEntries}"
                      SelectionChanged="FileGrid_SelectionChanged"
                      MouseDoubleClick="FileGrid_MouseDoubleClick">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="Name" Binding="{Binding Name}" Width="*" MinWidth="200" />
                    <DataGridTextColumn Header="Type" Binding="{Binding FileType}" Width="120" />
                    <DataGridTextColumn Header="Size" Binding="{Binding SizeFormatted}" Width="100">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="HorizontalAlignment" Value="Right" />
                                <Setter Property="Padding" Value="0,0,12,0" />
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                    <DataGridTextColumn Header="Offset" Binding="{Binding Offset}" Width="80">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="HorizontalAlignment" Value="Right" />
                                <Setter Property="Padding" Value="0,0,12,0" />
                                <Setter Property="Foreground" Value="{StaticResource TextSecondaryBrush}" />
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                </DataGrid.Columns>

                <DataGrid.ContextMenu>
                    <ContextMenu>
                        <MenuItem Header="Export Selected..." Command="{Binding ExportSelectedCommand}">
                            <MenuItem.Icon>
                                <fa:ImageAwesome Icon="Upload" Width="14" Height="14" Foreground="{StaticResource TextPrimaryBrush}" />
                            </MenuItem.Icon>
                        </MenuItem>
                        <Separator />
                        <MenuItem Header="Rename..." Command="{Binding RenameEntryCommand}">
                            <MenuItem.Icon>
                                <fa:ImageAwesome Icon="Pencil" Width="14" Height="14" Foreground="{StaticResource TextPrimaryBrush}" />
                            </MenuItem.Icon>
                        </MenuItem>
                        <MenuItem Header="Replace..." Command="{Binding ReplaceEntryCommand}">
                            <MenuItem.Icon>
                                <fa:ImageAwesome Icon="Exchange" Width="14" Height="14" Foreground="{StaticResource TextPrimaryBrush}" />
                            </MenuItem.Icon>
                        </MenuItem>
                        <Separator />
                        <MenuItem Header="Delete Selected" Command="{Binding DeleteSelectedCommand}">
                            <MenuItem.Icon>
                                <fa:ImageAwesome Icon="Trash" Width="14" Height="14" Foreground="{StaticResource TextPrimaryBrush}" />
                            </MenuItem.Icon>
                        </MenuItem>
                        <Separator />
                        <MenuItem Header="Select All" Click="SelectAll_Click">
                            <MenuItem.Icon>
                                <fa:ImageAwesome Icon="CheckSquare" Width="14" Height="14" Foreground="{StaticResource TextPrimaryBrush}" />
                            </MenuItem.Icon>
                        </MenuItem>
                    </ContextMenu>
                </DataGrid.ContextMenu>
            </DataGrid>

            <!-- Loading Overlay -->
            <Border Background="#80000000" Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibilityConverter}}">
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                    <fa:ImageAwesome Icon="Cog" Width="32" Height="32" Foreground="{StaticResource AccentBrush}" 
                                     Spin="True" SpinDuration="2" HorizontalAlignment="Center" />
                    <TextBlock Text="{Binding StatusMessage}" Foreground="{StaticResource TextPrimaryBrush}"
                               HorizontalAlignment="Center" Margin="0,12,0,0" />
                </StackPanel>
            </Border>
        </Grid>

        <!-- Status Bar -->
            <StatusBar Grid.Row="4">
            <StatusBarItem>
                <TextBlock Text="{Binding StatusMessage}" />
            </StatusBarItem>
            <StatusBarItem HorizontalAlignment="Right">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="{Binding ArchiveInfo}" Margin="0,0,16,0" />
                    <TextBlock Text="{Binding SelectedEntries.Count, StringFormat='{}{0} selected'}" 
                               Visibility="{Binding HasSelection, Converter={StaticResource BoolToVisibilityConverter}}" />
                </StackPanel>
            </StatusBarItem>
            </StatusBar>
        </Grid>
    </Border>
</Window>
